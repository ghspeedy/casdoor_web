var F=Object.defineProperty;var P=(v,t,e)=>t in v?F(v,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):v[t]=e;var T=(v,t,e)=>(P(v,typeof t!="symbol"?t+"":t,e),e);import{R as w,F as C,l as I,b as E,s as o,i,j as a,B as y,f as d,I as g,T as A,h as b,w as k,e as p,n as h,o as n,x as c,r as f,X as z}from"./index-a4571b31.js";import{s as $,U as V,A as L,R,b as N,u as M,d as O}from"./AdapterBackend-d14ef1d5.js";import"./javascript-d96a5cf8.js";import{g as D}from"./ModelBackend-832b6120.js";import{T as U}from"./Table-4974f722.js";import{P as j}from"./index-3220aa08.js";import{E as q}from"./EditOutlined-5f57c71a.js";import{D as Q}from"./DeleteOutlined-4c84e7f6.js";import"./javascript-0700ad20.js";import{I as B}from"./index-b32b9059.js";import{S as H}from"./index-c1f94e42.js";import"./DeleteOutlined-25685737.js";import"./UpOutlined-7082c42f.js";class K extends w.Component{constructor(e){super(e);T(this,"count",0);T(this,"pageSize",10);T(this,"isEditing",e=>e===this.state.editingIndex);T(this,"edit",(e,r)=>{this.setState({editingIndex:r,oldPolicy:C(e)})});T(this,"cancel",(e,r)=>{Object.keys(e[this.getIndex(r)]).forEach(s=>{e[this.getIndex(r)][s]=this.state.oldPolicy[s]}),this.updateTable(e),this.setState({editingIndex:"",oldPolicy:""}),this.state.add&&(this.deleteRow(this.state.policyLists,r),this.setState({add:!1}))});this.state={policyLists:[],loading:!1,editingIndex:"",oldPolicy:"",add:!1,page:1}}getIndex(e){return e+(this.state.page-1)*10}UNSAFE_componentWillMount(){this.props.mode==="edit"&&this.synPolicies()}updateTable(e){this.setState({policyLists:e})}updateField(e,r,s,m){e[this.getIndex(r)][s]=m,this.updateTable(e)}addRow(e){const r={key:this.count,Ptype:"p"};e===void 0&&(e=[]),e=I(e,r,"top"),this.count=this.count+1,this.updateTable(e),this.edit(r,0),this.setState({page:1,add:!0})}deleteRow(e,r){e=E(e,this.getIndex(r)),this.updateTable(e)}save(e,r){this.state.add?this.addPolicy(e,r):this.updatePolicy(e,r)}synPolicies(){this.setState({loading:!0}),$(this.props.owner,this.props.name).then(e=>{if(e.status==="ok"){o("success",i.t("adapter:Sync policies successfully"));const r=e.data;r.map((s,m)=>{s.key=m}),this.count=r.length,this.setState({policyLists:r})}else o("error",`${i.t("adapter:Failed to sync policies")}: ${e.msg}`);this.setState({loading:!1})}).catch(e=>{o("error",`${i.t("general:Failed to connect to server")}: ${e}`)})}updatePolicy(e,r){V(this.props.owner,this.props.name,[this.state.oldPolicy,e[r]]).then(s=>{s.status==="ok"?(this.setState({editingIndex:"",oldPolicy:""}),o("success",i.t("general:Successfully saved"))):o("error",`${i.t("general:Failed to save")}: ${s.msg}`)})}addPolicy(e,r){L(this.props.owner,this.props.name,e[r]).then(s=>{s.status==="ok"?(this.setState({editingIndex:"",oldPolicy:"",add:!1}),s.data!=="Affected"?(s.msg=i.t("adapter:Duplicated policy rules"),o("error",`${i.t("general:Failed to add")}: ${s.msg}`)):o("success",i.t("general:Successfully added"))):o("error",`${i.t("general:Failed to add")}: ${s.msg}`)})}deletePolicy(e,r){R(this.props.owner,this.props.name,e[this.getIndex(r)]).then(s=>{s.status==="ok"?(o("success",i.t("general:Successfully deleted")),this.deleteRow(e,r)):o("error",i.t("general:Failed to delete"))})}renderTable(e){const r=[{title:"Rule Type",dataIndex:"Ptype",width:"100px"},{title:"V0",dataIndex:"V0",width:"100px",render:(s,m,l)=>this.isEditing(l)?a(g,{value:s,onChange:u=>{this.updateField(e,l,"V0",u.target.value)}}):s},{title:"V1",dataIndex:"V1",width:"100px",render:(s,m,l)=>this.isEditing(l)?a(g,{value:s,onChange:u=>{this.updateField(e,l,"V1",u.target.value)}}):s},{title:"V2",dataIndex:"V2",width:"100px",render:(s,m,l)=>this.isEditing(l)?a(g,{value:s,onChange:u=>{this.updateField(e,l,"V2",u.target.value)}}):s},{title:"V3",dataIndex:"V3",width:"100px",render:(s,m,l)=>this.isEditing(l)?a(g,{value:s,onChange:u=>{this.updateField(e,l,"V3",u.target.value)}}):s},{title:"V4",dataIndex:"V4",width:"100px",render:(s,m,l)=>this.isEditing(l)?a(g,{value:s,onChange:u=>{this.updateField(e,l,"V4",u.target.value)}}):s},{title:"V5",dataIndex:"V5",width:"100px",render:(s,m,l)=>this.isEditing(l)?a(g,{value:s,onChange:u=>{this.updateField(e,l,"V5",u.target.value)}}):s},{title:"Option",key:"option",width:"100px",render:(s,m,l)=>this.isEditing(l)?d("span",{children:[a(y,{style:{marginRight:8},onClick:()=>this.save(e,l),children:"Save"}),a(j,{title:"Sure to cancel?",onConfirm:()=>this.cancel(e,l),children:a("a",{children:"Cancel"})})]}):d("div",{children:[a(A,{placement:"topLeft",title:"Edit",children:a(y,{disabled:this.state.editingIndex!=="",style:{marginRight:"5px"},icon:a(q,{}),size:"small",onClick:()=>this.edit(m,l)})}),a(A,{placement:"topLeft",title:"Delete",children:a(y,{disabled:this.state.editingIndex!=="",style:{marginRight:"5px"},icon:a(Q,{}),size:"small",onClick:()=>this.deletePolicy(e,l)})})]})}];return a(U,{pagination:{defaultPageSize:this.pageSize,onChange:s=>this.setState({page:s}),disabled:this.state.editingIndex!=="",current:this.state.page},columns:r,dataSource:e,rowKey:"key",size:"middle",bordered:!0,loading:this.state.loading,title:()=>a("div",{children:a(y,{disabled:this.state.editingIndex!=="",style:{marginRight:"5px"},type:"primary",size:"small",onClick:()=>this.addRow(e),children:i.t("general:Add")})})})}render(){return d(w.Fragment,{children:[a(y,{type:"primary",disabled:this.state.editingIndex!=="",onClick:()=>{this.synPolicies()},children:i.t("general:Sync")}),this.renderTable(this.state.policyLists)]})}}const{Option:S}=f;class ne extends w.Component{constructor(t){super(t),this.state={classes:t,owner:t.organizationName!==void 0?t.organizationName:t.match.params.organizationName,adapterName:t.match.params.adapterName,adapter:null,organizations:[],models:[],mode:t.location.mode!==void 0?t.location.mode:"edit"}}UNSAFE_componentWillMount(){this.getAdapter(),this.getOrganizations()}getAdapter(){N(this.state.owner,this.state.adapterName).then(t=>{t.status==="ok"&&(this.setState({adapter:t.data}),this.getModels(this.state.owner))})}getOrganizations(){b("admin").then(t=>{this.setState({organizations:t.msg===void 0?t:[]})})}getModels(t){D(t).then(e=>{this.setState({models:e})})}parseAdapterField(t,e){return["port"].includes(t)&&(e=z(e)),e}updateAdapterField(t,e){e=this.parseAdapterField(t,e);const r=this.state.adapter;r[t]=e,this.setState({adapter:r})}renderAdapter(){return d(k,{size:"small",title:d("div",{children:[this.state.mode==="add"?i.t("adapter:New Adapter"):i.t("adapter:Edit Adapter"),"    ",a(y,{onClick:()=>this.submitAdapterEdit(!1),children:i.t("general:Save")}),a(y,{style:{marginLeft:"20px"},type:"primary",onClick:()=>this.submitAdapterEdit(!0),children:i.t("general:Save & Exit")}),this.state.mode==="add"?a(y,{style:{marginLeft:"20px"},onClick:()=>this.deleteAdapter(),children:i.t("general:Cancel")}):null]}),style:p()?{margin:"5px"}:{},type:"inner",children:[d(h,{style:{marginTop:"10px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("general:Organization"),i.t("general:Organization - Tooltip"))," :"]}),a(n,{span:22,children:a(f,{virtual:!1,style:{width:"100%"},value:this.state.adapter.organization,onChange:t=>{this.getModels(t),this.updateAdapterField("organization",t)},children:this.state.organizations.map((t,e)=>a(S,{value:t.name,children:t.name},e))})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("general:Name"),i.t("general:Name - Tooltip"))," :"]}),a(n,{span:22,children:a(g,{value:this.state.adapter.name,onChange:t=>{this.updateAdapterField("name",t.target.value)}})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("provider:Type"),i.t("provider:Type - Tooltip"))," :"]}),a(n,{span:22,children:a(f,{virtual:!1,style:{width:"100%"},value:this.state.adapter.type,onChange:t=>{this.updateAdapterField("type",t);const e=this.state.adapter;this.setState({adapter:e})},children:["Database"].map((t,e)=>a(S,{value:t,children:t},e))})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("provider:Host"),i.t("provider:Host - Tooltip"))," :"]}),a(n,{span:22,children:a(g,{value:this.state.adapter.host,onChange:t=>{this.updateAdapterField("host",t.target.value)}})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("provider:Port"),i.t("provider:Port - Tooltip"))," :"]}),a(n,{span:22,children:a(B,{value:this.state.adapter.port,onChange:t=>{this.updateAdapterField("port",t)}})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("general:User"),i.t("general:User - Tooltip"))," :"]}),a(n,{span:22,children:a(g,{value:this.state.adapter.user,onChange:t=>{this.updateAdapterField("user",t.target.value)}})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("general:Password"),i.t("general:Password - Tooltip"))," :"]}),a(n,{span:22,children:a(g,{value:this.state.adapter.password,onChange:t=>{this.updateAdapterField("password",t.target.value)}})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("syncer:Database type"),i.t("syncer:Database type - Tooltip"))," :"]}),a(n,{span:22,children:a(f,{virtual:!1,style:{width:"100%"},value:this.state.adapter.databaseType,onChange:t=>{this.updateAdapterField("databaseType",t)},children:[{id:"mysql",name:"MySQL"},{id:"postgres",name:"PostgreSQL"},{id:"mssql",name:"SQL Server"},{id:"oracle",name:"Oracle"},{id:"sqlite3",name:"Sqlite 3"}].map((t,e)=>a(S,{value:t.id,children:t.name},e))})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("syncer:Database"),i.t("syncer:Database - Tooltip"))," :"]}),a(n,{span:22,children:a(g,{value:this.state.adapter.database,onChange:t=>{this.updateAdapterField("database",t.target.value)}})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("syncer:Table"),i.t("syncer:Table - Tooltip"))," :"]}),a(n,{span:22,children:a(g,{value:this.state.adapter.table,disabled:this.state.adapter.type==="Keycloak",onChange:t=>{this.updateAdapterField("table",t.target.value)}})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("general:Model"),i.t("general:Model - Tooltip"))," :"]}),a(n,{span:22,children:a(f,{virtual:!1,style:{width:"100%"},value:this.state.adapter.model,onChange:t=>{this.updateAdapterField("model",t)},children:this.state.models.map((t,e)=>a(S,{value:t.name,children:t.name},e))})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?22:2,children:[c(i.t("adapter:Policies"),i.t("adapter:Policies - Tooltip"))," :"]}),a(n,{span:22,children:a(K,{owner:this.state.owner,name:this.state.adapterName,mode:this.state.mode})})]}),d(h,{style:{marginTop:"20px"},children:[d(n,{style:{marginTop:"5px"},span:p()?19:2,children:[c(i.t("general:Is enabled"),i.t("general:Is enabled - Tooltip"))," :"]}),a(n,{span:1,children:a(H,{checked:this.state.adapter.isEnabled,onChange:t=>{this.updateAdapterField("isEnabled",t)}})})]})]})}submitAdapterEdit(t){const e=C(this.state.adapter);M(this.state.adapter.owner,this.state.adapterName,e).then(r=>{r.status==="ok"?(o("success",i.t("general:Successfully saved")),this.setState({adapterName:this.state.adapter.name}),t?this.props.history.push("/adapters"):this.props.history.push(`/adapters/${this.state.owner}/${this.state.adapter.name}`)):(o("error",`${i.t("general:Failed to save")}: ${r.msg}`),this.updateAdapterField("name",this.state.adapterName))}).catch(r=>{o("error",`${i.t("general:Failed to connect to server")}: ${r}`)})}deleteAdapter(){O(this.state.adapter).then(t=>{t.status==="ok"?this.props.history.push("/adapters"):o("error",`${i.t("general:Failed to delete")}: ${t.msg}`)}).catch(t=>{o("error",`${i.t("general:Failed to connect to server")}: ${t}`)})}render(){return d("div",{children:[this.state.adapter!==null?this.renderAdapter():null,d("div",{style:{marginTop:"20px",marginLeft:"40px"},children:[a(y,{size:"large",onClick:()=>this.submitAdapterEdit(!1),children:i.t("general:Save")}),a(y,{style:{marginLeft:"20px"},type:"primary",size:"large",onClick:()=>this.submitAdapterEdit(!0),children:i.t("general:Save & Exit")}),this.state.mode==="add"?a(y,{style:{marginLeft:"20px"},size:"large",onClick:()=>this.deleteAdapter(),children:i.t("general:Cancel")}):null]})]})}}export{ne as default};
