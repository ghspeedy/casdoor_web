import{dr as $,R as v,dt as w,du as L,s as m,i as S,dv as P,dw as C,dx as T,m as u,ag as b,j as h,dy as A,bN as M,dz as x,ab as _}from"./index-a4571b31.js";class q extends v.Component{constructor(a){super(a),this.state={classes:a,msg:null,samlResponse:"",relayState:"",redirectUrl:""}}getInnerParams(){const o=new URLSearchParams(this.props.location.search).get("state"),t=w(o);return new URLSearchParams(t)}getResponseType(){const a=_.serverUrl,o=this.getInnerParams(),t=o.get("method");if(t==="signup"){const n=o.get("redirect_uri");if(n===null){const c=o.get("SAMLRequest"),l=o.get("service");return c!=null&&c!==""?"saml":l!=null&&l!==""?"cas":"login"}const d=new URL(n).origin;if(a===d)return"login";{const c=o.get("response_type");return c!==null?c:"code"}}else return t==="link"?"link":"unknown"}UNSAFE_componentWillMount(){var R;const a=new URLSearchParams(this.props.location.search),o=a.get("openid.mode");let t=a.get("code");t===null&&(t=a.get("auth_code")),t===null&&(t=a.get("authCode")),o!==null&&t===null&&(t=this.props.location.search);const n=this.getInnerParams(),d=n.get("application"),c=n.get("provider"),l=n.get("method"),U=n.get("SAMLRequest"),g=n.get("service"),k=`${window.location.origin}/callback`,f={type:this.getResponseType(),application:d,provider:c,code:t,samlRequest:U,state:d,redirectUri:k,method:l};if(this.getResponseType()==="cas"){L(f,{service:g}).then(e=>{if(e.status==="ok"){let i="Logged in successfully.";if(g===""&&(i+="Now you can visit apps protected by Casdoor."),m("success",i),g!==""){const s=e.data,p=new URL(g);p.searchParams.append("ticket",s),window.location.href=p.toString()}}else m("error",`${S.t("application:Failed to sign in")}: ${e.msg}`)});return}const r=P(n),y=(R=r==null?void 0:r.redirectUri)!=null&&R.includes("?")?"&":"?";C(f,r).then(e=>{if(e.status==="ok"){const i=this.getResponseType();if(i==="login"){m("success","Logged in successfully");const s=T();u(s)}else if(i==="code"){const s=e.data;u(`${r.redirectUri}${y}code=${s}&state=${r.state}`)}else if(i==="token"||i==="id_token"){const s=e.data;u(`${r.redirectUri}${y}${i}=${s}&state=${r.state}&token_type=bearer`)}else if(i==="link"){const s=n.get("from");b(this,s)}else if(i==="saml")if(e.data2.method==="POST")this.setState({samlResponse:e.data,redirectUrl:e.data2.redirectUrl,relayState:r.relayState});else{const s=e.data,p=e.data2.redirectUrl;u(`${p}?SAMLResponse=${encodeURIComponent(s)}&RelayState=${r.relayState}`)}}else this.setState({msg:e.msg})})}render(){return this.state.samlResponse!==""?h(A,{samlResponse:this.state.samlResponse,redirectUrl:this.state.redirectUrl,relayState:this.state.relayState}):h("div",{style:{display:"flex",justifyContent:"center",alignItems:"center"},children:this.state.msg===null?h(M,{size:"large",tip:S.t("login:Signing in..."),style:{paddingTop:"10%"}}):x(this,this.state.msg)})}}const N=$(q);export{N as default};
