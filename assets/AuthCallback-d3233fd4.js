import{dN as $,R as L,dP as v,dQ as w,s as m,i as y,dR as P,dS as T,dT as C,l as u,af as x,j as h,dU as A,cn as M,dV as b,aa as j}from"./index-ba7d0766.js";class _ extends L.Component{constructor(a){super(a),this.state={classes:a,msg:null,samlResponse:"",relayState:"",redirectUrl:""}}getInnerParams(){const o=new URLSearchParams(this.props.location.search).get("state"),t=v(o);return new URLSearchParams(t)}getResponseType(){const a=j.serverUrl,o=this.getInnerParams(),t=o.get("method");if(t==="signup"){const n=o.get("redirect_uri");if(n===null){const c=o.get("SAMLRequest"),l=o.get("service");return c!=null&&c!==""?"saml":l!=null&&l!==""?"cas":"login"}const d=new URL(n).origin;if(a===d)return"login";{const c=o.get("response_type");return c!==null?c:"code"}}else return t==="link"?"link":"unknown"}UNSAFE_componentWillMount(){var S;const a=new URLSearchParams(this.props.location.search),o=a.get("openid.mode");let t=a.get("code");t===null&&(t=a.get("auth_code")),t===null&&(t=a.get("authCode")),o!==null&&t===null&&(t=this.props.location.search);const n=this.getInnerParams(),d=n.get("application"),c=n.get("provider"),l=n.get("method"),U=n.get("SAMLRequest"),g=n.get("service"),k=`${window.location.origin}/callback`,f={type:this.getResponseType(),application:d,provider:c,code:t,samlRequest:U,state:d,redirectUri:k,method:l};if(this.getResponseType()==="cas"){w(f,{service:g}).then(e=>{if(e.status==="ok"){let i="Logged in successfully.";if(g===""&&(i+="Now you can visit apps protected by Casdoor."),m("success",i),g!==""){const s=e.data,p=new URL(g);p.searchParams.append("ticket",s),window.location.href=p.toString()}}else m("error",`${y.t("application:Failed to sign in")}: ${e.msg}`)});return}const r=P(n),R=(S=r==null?void 0:r.redirectUri)!=null&&S.includes("?")?"&":"?";T(f,r).then(e=>{if(e.status==="ok"){const i=this.getResponseType();if(i==="login"){m("success","Logged in successfully");const s=C();u(s)}else if(i==="code"){const s=e.data;u(`${r.redirectUri}${R}code=${s}&state=${r.state}`)}else if(i==="token"||i==="id_token"){const s=e.data;u(`${r.redirectUri}${R}${i}=${s}&state=${r.state}&token_type=bearer`)}else if(i==="link"){const s=n.get("from");x(this,s)}else if(i==="saml")if(e.data2.method==="POST")this.setState({samlResponse:e.data,redirectUrl:e.data2.redirectUrl,relayState:r.relayState});else{const s=e.data,p=e.data2.redirectUrl;u(`${p}?SAMLResponse=${encodeURIComponent(s)}&RelayState=${r.relayState}`)}}else this.setState({msg:e.msg})})}render(){return this.state.samlResponse!==""?h.jsx(A,{samlResponse:this.state.samlResponse,redirectUrl:this.state.redirectUrl,relayState:this.state.relayState}):h.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center"},children:this.state.msg===null?h.jsx(M,{size:"large",tip:y.t("login:Signing in..."),style:{paddingTop:"10%"}}):b(this,this.state.msg)})}}const I=$(_);export{I as default};
