import{R as N,s as c,i as a,k as D,b as A,j as e,L as F,B as h,l as O,m as o,n as s,o as I,p as S,q as x,r as P,T as z,D as $,t as E,u as U,v as B,e as d,w as p,I as y,x as T,y as M,z as W,C as _,A as R,E as G,F as H,G as K,d as V}from"./index-ba7d0766.js";import{a as q,d as J,g as Q}from"./LdapBackend-3f76eeae.js";import{P as X}from"./PopconfirmModal-2c22ff01.js";import{T as L,R as f}from"./Table-c2bde13f.js";import{S as C}from"./index-ae4cddc7.js";import{U as Y}from"./UpOutlined-c7f9b9eb.js";import{D as Z}from"./DeleteOutlined-b2ad8e5b.js";import{T as ee}from"./ThemeEditor-ee4863e2.js";import{L as v}from"./LinkOutlined-b2beeea9.js";import{I as ae}from"./index-4091184f.js";import"./index-2f07707f.js";import"./UpOutlined-7082c42f.js";import"./DeleteOutlined-25685737.js";class te extends N.Component{constructor(t){super(t),this.state={classes:t}}updateTable(t){this.props.onUpdateTable(t)}updateField(t,l,n,r){t[l][n]=r,this.updateTable(t)}newLdap(){return{id:"",owner:this.props.organizationName,createdTime:"",serverName:"Example LDAP Server",host:"example.com",port:389,admin:"cn=admin,dc=example,dc=com",passwd:"123",baseDn:"ou=People,dc=example,dc=com",autosync:0,lastSync:""}}addRow(t){const l=this.newLdap();q(l).then(n=>{n.status==="ok"?(c("success",a.t("general:Successfully added")),t===void 0&&(t=[]),t=D(t,n.data2),this.updateTable(t)):c("error",`${a.t("general:Failed to add")}: ${n.msg}`)}).catch(n=>{c("error",`Add LDAP server failed: ${n}`)})}deleteRow(t,l){J(t[l]).then(n=>{n.status==="ok"?(c("success",a.t("general:Successfully deleted")),t=A(t,l),this.updateTable(t)):c("error",`${a.t("general:Failed to delete")}: ${n.msg}`)}).catch(n=>{c("error",`Delete LDAP server failed: ${n}`)})}renderTable(t){const l=[{title:a.t("ldap:Server name"),dataIndex:"serverName",key:"serverName",width:"160px",sorter:(n,r)=>n.serverName.localeCompare(r.serverName),render:(n,r,i)=>e.jsx(F,{to:`/ldaps/${r.id}`,children:n})},{title:a.t("ldap:Server"),dataIndex:"host",key:"host",ellipsis:!0,sorter:(n,r)=>n.host.localeCompare(r.host),render:(n,r,i)=>`${n}:${r.port}`},{title:a.t("ldap:Base DN"),dataIndex:"baseDn",key:"baseDn",ellipsis:!0,sorter:(n,r)=>n.baseDn.localeCompare(r.baseDn)},{title:a.t("ldap:Auto Sync"),dataIndex:"autoSync",key:"autoSync",width:"120px",sorter:(n,r)=>n.autoSync.localeCompare(r.autoSync),render:(n,r,i)=>n===0?e.jsx("span",{style:{color:"#faad14"},children:"Disable"}):e.jsx("span",{style:{color:"#52c41a"},children:n+" mins"})},{title:a.t("ldap:Last Sync"),dataIndex:"lastSync",key:"lastSync",ellipsis:!0,sorter:(n,r)=>n.lastSync.localeCompare(r.lastSync),render:(n,r,i)=>n},{title:a.t("general:Action"),dataIndex:"",key:"op",width:"240px",render:(n,r,i)=>e.jsxs("div",{children:[e.jsx(h,{style:{marginTop:"10px",marginBottom:"10px",marginRight:"10px"},type:"primary",onClick:()=>O(`/ldap/sync/${r.owner}/${r.id}`),children:a.t("general:Sync")}),e.jsx(h,{style:{marginTop:"10px",marginBottom:"10px",marginRight:"10px"},onClick:()=>O(`/ldap/${r.owner}/${r.id}`),children:a.t("general:Edit")}),e.jsx(X,{title:a.t("general:Sure to delete")+`: ${r.serverName} ?`,onConfirm:()=>this.deleteRow(t,i)})]})}];return e.jsx(L,{scroll:{x:"max-content"},rowKey:"id",columns:l,dataSource:t,size:"middle",bordered:!0,pagination:!1,title:()=>e.jsxs("div",{children:[this.props.title,"    ",e.jsx(h,{style:{marginRight:"5px"},type:"primary",size:"small",onClick:()=>this.addRow(t),children:a.t("general:Add")})]})})}render(){return e.jsx("div",{children:e.jsx(o,{style:{marginTop:"20px"},children:e.jsx(s,{span:24,children:this.renderTable(this.props.table)})})})}}const{Option:w}=x;class ie extends N.Component{constructor(t){super(t),this.state={classes:t}}updateTable(t){this.props.onUpdateTable(t)}updateField(t,l,n,r){t[l][n]=r,this.updateTable(t)}addRow(t){const l={name:I(t,"Please select an account item"),visible:!0,viewRule:"Public",modifyRule:"Self"};t===void 0&&(t=[]),t=D(t,l),this.updateTable(t)}deleteRow(t,l){t=A(t,l),this.updateTable(t)}upRow(t,l){t=S(t,l-1,l),this.updateTable(t)}downRow(t,l){t=S(t,l,l+1),this.updateTable(t)}renderTable(t){const l=[{title:a.t("general:Name"),dataIndex:"name",key:"name",render:(n,r,i)=>{const g=[{name:"Organization",displayName:a.t("general:Organization")},{name:"ID",displayName:a.t("general:ID")},{name:"Name",displayName:a.t("general:Name")},{name:"Display name",displayName:a.t("general:Display name")},{name:"Avatar",displayName:a.t("general:Avatar")},{name:"User type",displayName:a.t("general:User type")},{name:"Password",displayName:a.t("general:Password")},{name:"Email",displayName:a.t("general:Email")},{name:"Phone",displayName:a.t("general:Phone")},{name:"Country code",displayName:a.t("user:Country code")},{name:"Country/Region",displayName:a.t("user:Country/Region")},{name:"Location",displayName:a.t("user:Location")},{name:"Affiliation",displayName:a.t("user:Affiliation")},{name:"Title",displayName:a.t("user:Title")},{name:"Homepage",displayName:a.t("user:Homepage")},{name:"Bio",displayName:a.t("user:Bio")},{name:"Tag",displayName:a.t("user:Tag")},{name:"Signup application",displayName:a.t("general:Signup application")},{name:"Roles",displayName:a.t("general:Roles")},{name:"Permissions",displayName:a.t("general:Permissions")},{name:"3rd-party logins",displayName:a.t("user:3rd-party logins")},{name:"Properties",displayName:a.t("user:Properties")},{name:"Is admin",displayName:a.t("user:Is admin")},{name:"Is globalThis admin",displayName:a.t("user:Is globalThis admin")},{name:"Is forbidden",displayName:a.t("user:Is forbidden")},{name:"Is deleted",displayName:a.t("user:Is deleted")},{name:"WebAuthn credentials",displayName:a.t("user:WebAuthn credentials")},{name:"Managed accounts",displayName:a.t("user:Managed accounts")}],m=u=>{const j=g.filter(k=>k.name===u);return j.length===0?"":j[0].displayName};return e.jsx(x,{virtual:!1,style:{width:"100%"},value:m(n),onChange:u=>{this.updateField(t,i,"name",u)},children:P(g,t,"name").map((u,j)=>e.jsx(w,{value:u.name,children:u.displayName},j))})}},{title:a.t("organization:Visible"),dataIndex:"visible",key:"visible",width:"120px",render:(n,r,i)=>e.jsx(C,{checked:n,onChange:g=>{this.updateField(t,i,"visible",g)}})},{title:a.t("organization:View rule"),dataIndex:"viewRule",key:"viewRule",width:"155px",render:(n,r,i)=>{if(!r.visible)return null;const g=[{id:"Public",name:"Public"},{id:"Self",name:"Self"},{id:"Admin",name:"Admin"}];return e.jsx(x,{virtual:!1,style:{width:"100%"},value:n,onChange:m=>{this.updateField(t,i,"viewRule",m)},children:g.map((m,u)=>e.jsx(w,{value:m.id,children:m.name},u))})}},{title:a.t("organization:Modify rule"),dataIndex:"modifyRule",key:"modifyRule",width:"155px",render:(n,r,i)=>{if(!r.visible)return null;let g;return r.viewRule==="Admin"||r.name==="Is admin"||r.name==="Is globalThis admin"?g=[{id:"Admin",name:"Admin"},{id:"Immutable",name:"Immutable"}]:g=[{id:"Self",name:"Self"},{id:"Admin",name:"Admin"},{id:"Immutable",name:"Immutable"}],e.jsx(x,{virtual:!1,style:{width:"100%"},value:n,onChange:m=>{this.updateField(t,i,"modifyRule",m)},children:g.map((m,u)=>e.jsx(w,{value:m.id,children:m.name},u))})}},{title:a.t("general:Action"),key:"action",width:"100px",render:(n,r,i)=>e.jsxs("div",{children:[e.jsx(z,{placement:"bottomLeft",title:a.t("general:Up"),children:e.jsx(h,{style:{marginRight:"5px"},disabled:i===0,icon:e.jsx(Y,{}),size:"small",onClick:()=>this.upRow(t,i)})}),e.jsx(z,{placement:"topLeft",title:a.t("general:Down"),children:e.jsx(h,{style:{marginRight:"5px"},disabled:i===t.length-1,icon:e.jsx($,{}),size:"small",onClick:()=>this.downRow(t,i)})}),e.jsx(z,{placement:"topLeft",title:a.t("general:Delete"),children:e.jsx(h,{icon:e.jsx(Z,{}),size:"small",onClick:()=>this.deleteRow(t,i)})})]})}];return e.jsx(L,{scroll:{x:"max-content"},rowKey:"name",columns:l,dataSource:t,size:"middle",bordered:!0,pagination:!1,title:()=>e.jsxs("div",{children:[this.props.title,"    ",e.jsx(h,{style:{marginRight:"5px"},type:"primary",size:"small",onClick:()=>this.addRow(t),children:a.t("general:Add")})]})})}render(){return e.jsx("div",{children:e.jsx(o,{style:{marginTop:"20px"},children:e.jsx(s,{span:24,children:this.renderTable(this.props.table)})})})}}const{Option:ne}=x;class je extends N.Component{constructor(t){super(t),this.state={classes:t,organizationName:t.match.params.organizationName,organization:null,applications:[],ldaps:null,mode:t.location.mode!==void 0?t.location.mode:"edit"}}UNSAFE_componentWillMount(){this.getOrganization(),this.getApplications(),this.getLdaps()}getOrganization(){E("admin",this.state.organizationName).then(t=>{this.setState({organization:t})})}getApplications(){U("admin",this.state.organizationName).then(t=>{this.setState({applications:t})})}getLdaps(){Q(this.state.organizationName).then(t=>{let l=[];t.status==="ok"&&t.data!==null&&(l=t.data),this.setState({ldaps:l})})}parseOrganizationField(t,l){return l}updateOrganizationField(t,l){l=this.parseOrganizationField(t,l);const n=this.state.organization;n[t]=l,this.setState({organization:n})}renderOrganization(){var t,l,n,r;return e.jsxs(B,{size:"small",title:e.jsxs("div",{children:[this.state.mode==="add"?a.t("organization:New Organization"):a.t("organization:Edit Organization"),"    ",e.jsx(h,{onClick:()=>this.submitOrganizationEdit(!1),children:a.t("general:Save")}),e.jsx(h,{style:{marginLeft:"20px"},type:"primary",onClick:()=>this.submitOrganizationEdit(!0),children:a.t("general:Save & Exit")}),this.state.mode==="add"?e.jsx(h,{style:{marginLeft:"20px"},onClick:()=>this.deleteOrganization(),children:a.t("general:Cancel")}):null]}),style:d()?{margin:"5px"}:{},type:"inner",children:[e.jsxs(o,{style:{marginTop:"10px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:Name"),a.t("general:Name - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(y,{value:this.state.organization.name,disabled:this.state.organization.name==="built-in",onChange:i=>{this.updateOrganizationField("name",i.target.value)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:Display name"),a.t("general:Display name - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(y,{value:this.state.organization.displayName,onChange:i=>{this.updateOrganizationField("displayName",i.target.value)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:Favicon"),a.t("general:Favicon - Tooltip"))," :"]}),e.jsxs(s,{span:22,children:[e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:1,children:[p(a.t("general:URL"),a.t("general:URL - Tooltip"))," :"]}),e.jsx(s,{span:23,children:e.jsx(y,{prefix:e.jsx(v,{}),value:this.state.organization.favicon,onChange:i=>{this.updateOrganizationField("favicon",i.target.value)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:1,children:[a.t("general:Preview"),":"]}),e.jsx(s,{span:23,children:e.jsx("a",{target:"_blank",rel:"noreferrer",href:this.state.organization.favicon,children:e.jsx("img",{src:this.state.organization.favicon,alt:this.state.organization.favicon,height:90,style:{marginBottom:"20px"}})})})]})]})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("organization:Website URL"),a.t("organization:Website URL - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(y,{prefix:e.jsx(v,{}),value:this.state.organization.websiteUrl,onChange:i=>{this.updateOrganizationField("websiteUrl",i.target.value)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:Password type"),a.t("general:Password type - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(x,{virtual:!1,style:{width:"100%"},value:this.state.organization.passwordType,onChange:i=>{this.updateOrganizationField("passwordType",i)},options:["plain","salt","md5-salt","bcrypt","pbkdf2-salt","argon2id"].map(i=>T(i,i))})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:Password salt"),a.t("general:Password salt - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(y,{value:this.state.organization.passwordSalt,onChange:i=>{this.updateOrganizationField("passwordSalt",i.target.value)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:Supported country codes"),a.t("general:Supported country codes - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(x,{virtual:!1,mode:"multiple",style:{width:"100%"},value:this.state.organization.countryCodes??[],onChange:i=>{this.updateOrganizationField("countryCodes",i)},filterOption:(i,g)=>((g==null?void 0:g.text)??"").toLowerCase().includes(i.toLowerCase()),children:M().map(i=>W(i))})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:Default avatar"),a.t("general:Default avatar - Tooltip"))," :"]}),e.jsxs(s,{span:22,children:[e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:1,children:[p(a.t("general:URL"),a.t("general:URL - Tooltip"))," :"]}),e.jsx(s,{span:23,children:e.jsx(y,{prefix:e.jsx(v,{}),value:this.state.organization.defaultAvatar,onChange:i=>{this.updateOrganizationField("defaultAvatar",i.target.value)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:1,children:[a.t("general:Preview"),":"]}),e.jsx(s,{span:23,children:e.jsx("a",{target:"_blank",rel:"noreferrer",href:this.state.organization.defaultAvatar,children:e.jsx("img",{src:this.state.organization.defaultAvatar,alt:this.state.organization.defaultAvatar,height:90,style:{marginBottom:"20px"}})})})]})]})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:Default application"),a.t("general:Default application - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(x,{virtual:!1,style:{width:"100%"},value:this.state.organization.defaultApplication,onChange:i=>{this.updateOrganizationField("defaultApplication",i)},options:(t=this.state.applications)==null?void 0:t.map(i=>T(i.name,i.name))})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("organization:Tags"),a.t("organization:Tags - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(x,{virtual:!1,mode:"tags",style:{width:"100%"},value:this.state.organization.tags,onChange:i=>{this.updateOrganizationField("tags",i)},children:(l=this.state.organization.tags)==null?void 0:l.map((i,g)=>e.jsx(ne,{value:i,children:i},g))})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:Master password"),a.t("general:Master password - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(y,{value:this.state.organization.masterPassword,onChange:i=>{this.updateOrganizationField("masterPassword",i.target.value)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:Languages"),a.t("general:Languages - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(x,{virtual:!1,mode:"tags",style:{width:"100%"},options:_.map(i=>T(i.label,i.key)),value:this.state.organization.languages??[],onChange:i=>{this.updateOrganizationField("languages",i)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?19:2,children:[p(a.t("organization:Init score"),a.t("organization:Init score - Tooltip"))," :"]}),e.jsx(s,{span:4,children:e.jsx(ae,{value:this.state.organization.initScore,onChange:i=>{this.updateOrganizationField("initScore",i)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?19:2,children:[p(a.t("organization:Soft deletion"),a.t("organization:Soft deletion - Tooltip"))," :"]}),e.jsx(s,{span:1,children:e.jsx(C,{checked:this.state.organization.enableSoftDeletion,onChange:i=>{this.updateOrganizationField("enableSoftDeletion",i)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?19:2,children:[p(a.t("organization:Is profile public"),a.t("organization:Is profile public - Tooltip"))," :"]}),e.jsx(s,{span:1,children:e.jsx(C,{checked:this.state.organization.isProfilePublic,onChange:i=>{this.updateOrganizationField("isProfilePublic",i)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("organization:Account items"),a.t("organization:Account items - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(ie,{title:a.t("organization:Account items"),table:this.state.organization.accountItems,onUpdateTable:i=>{this.updateOrganizationField("accountItems",i)}})})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("theme:Theme"),a.t("theme:Theme - Tooltip"))," :"]}),e.jsxs(s,{span:22,style:{marginTop:"5px"},children:[e.jsx(o,{children:e.jsxs(f.Group,{value:((n=this.state.organization.themeData)==null?void 0:n.isEnabled)??!1,onChange:i=>{const{_:g,...m}=this.state.organization.themeData??{...R,isEnabled:!1};this.updateOrganizationField("themeData",{...m,isEnabled:i.target.value})},children:[e.jsx(f.Button,{value:!1,children:a.t("organization:Follow globalThis theme")}),e.jsx(f.Button,{value:!0,children:a.t("theme:Customize theme")})]})}),(r=this.state.organization.themeData)!=null&&r.isEnabled?e.jsx(o,{style:{marginTop:"20px"},children:e.jsx(ee,{themeData:this.state.organization.themeData,onThemeChange:(i,g)=>{const{isEnabled:m}=this.state.organization.themeData??{...R,isEnabled:!1};this.updateOrganizationField("themeData",{...g,isEnabled:m})}})}):null]})]}),e.jsxs(o,{style:{marginTop:"20px"},children:[e.jsxs(s,{style:{marginTop:"5px"},span:d()?22:2,children:[p(a.t("general:LDAPs"),a.t("general:LDAPs - Tooltip"))," :"]}),e.jsx(s,{span:22,children:e.jsx(te,{title:a.t("general:LDAPs"),table:this.state.ldaps,organizationName:this.state.organizationName,onUpdateTable:i=>{this.setState({ldaps:i})}})})]})]})}submitOrganizationEdit(t){const l=G(this.state.organization);H(this.state.organization.owner,this.state.organizationName,l).then(n=>{n.status==="ok"?(c("success",a.t("general:Successfully saved")),this.props.account.organization.name===this.state.organizationName&&this.props.onChangeTheme(K(this.state.organization)),this.setState({organizationName:this.state.organization.name}),t?this.props.history.push("/organizations"):this.props.history.push(`/organizations/${this.state.organization.name}`)):(c("error",`${a.t("general:Failed to save")}: ${n.msg}`),this.updateOrganizationField("name",this.state.organizationName))}).catch(n=>{c("error",`${a.t("general:Failed to connect to server")}: ${n}`)})}deleteOrganization(){V(this.state.organization).then(t=>{t.status==="ok"?this.props.history.push("/organizations"):c("error",`${a.t("general:Failed to delete")}: ${t.msg}`)}).catch(t=>{c("error",`${a.t("general:Failed to connect to server")}: ${t}`)})}render(){return e.jsxs("div",{children:[this.state.organization!==null?this.renderOrganization():null,e.jsxs("div",{style:{marginTop:"20px",marginLeft:"40px"},children:[e.jsx(h,{size:"large",onClick:()=>this.submitOrganizationEdit(!1),children:a.t("general:Save")}),e.jsx(h,{style:{marginLeft:"20px"},type:"primary",size:"large",onClick:()=>this.submitOrganizationEdit(!0),children:a.t("general:Save & Exit")}),this.state.mode==="add"?e.jsx(h,{style:{marginLeft:"20px"},size:"large",onClick:()=>this.deleteOrganization(),children:a.t("general:Cancel")}):null]})]})}}export{je as default};
