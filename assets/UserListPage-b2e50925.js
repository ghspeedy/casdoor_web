var $=Object.defineProperty;var U=(c,h,e)=>h in c?$(c,h,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[h]=e;var y=(c,h,e)=>(U(c,typeof h!="symbol"?h+"":h,e),e);import{g as j,S as I,H as F,J as N,s as l,i as a,K as A,b as O,j as s,B as m,e as p,L as x,c as P,M as T,N as k,O as v,P as R,Q as C,h as S,t as D,U as B}from"./index-f0baa7a0.js";import{h as M}from"./moment-fbc5633a.js";import{B as L}from"./BaseListPage-041c389a.js";import{P as E}from"./PopconfirmModal-8710d8ae.js";import{U as G,a as J}from"./UploadOutlined-a658b565.js";import{S as u}from"./index-821d4c24.js";import{T as K}from"./Table-f650b5e6.js";import"./index-9d454b6e.js";import"./DeleteOutlined-25685737.js";class ae extends L{constructor(e){super(e);y(this,"fetch",(e={})=>{const i=e.searchedColumn,o=e.searchText,t=e.sortField,n=e.sortOrder;this.setState({loading:!0}),this.props.match.params.organizationName===void 0?(v(this.props.account)?R(e.pagination.current,e.pagination.pageSize,i,o,t,n):C(this.props.account.owner,e.pagination.current,e.pagination.pageSize,i,o,t,n)).then(r=>{if(r.status==="ok"){this.setState({loading:!1,data:r.data,pagination:{...e.pagination,total:r.data2},searchText:e.searchText,searchedColumn:e.searchedColumn});const d=r.data;d.length>0&&this.getOrganization(d[0].owner)}else S(r)&&this.setState({loading:!1,isAuthorized:!1})}):C(this.props.match.params.organizationName,e.pagination.current,e.pagination.pageSize,i,o,t,n).then(r=>{if(r.status==="ok"){this.setState({loading:!1,data:r.data,pagination:{...e.pagination,total:r.data2},searchText:e.searchText,searchedColumn:e.searchedColumn});const d=r.data;d.length>0&&this.getOrganization(d[0].owner)}else S(r)&&this.setState({loading:!1,isAuthorized:!1})})})}componentDidMount(){this.setState({organizationName:this.props.match.params.organizationName,organization:null})}newUser(){var o;const e=j(),i=this.state.organizationName!==void 0?this.state.organizationName:this.props.account.owner;return{owner:i,name:`user_${e}`,createdTime:M().format(),type:"normal-user",password:"123",passwordSalt:"",displayName:`New User - ${e}`,avatar:`${I}/img/casbin.svg`,email:`${e}@example.com`,phone:F(),countryCode:((o=this.state.organization.countryCodes)==null?void 0:o.length)>0?this.state.organization.countryCodes[0]:"",address:[],affiliation:"Example Inc.",tag:"staff",region:"",isAdmin:i==="built-in",isGlobalAdmin:i==="built-in",IsForbidden:!1,score:this.state.organization.initScore,isDeleted:!1,properties:{},signupApplication:"app-built-in"}}addUser(){const e=this.newUser();N(e).then(i=>{i.status==="ok"?(this.props.history.push({pathname:`/users/${e.owner}/${e.name}`,mode:"add"}),l("success",a.t("general:Successfully added"))):l("error",`${a.t("general:Failed to add")}: ${i.msg}`)}).catch(i=>{l("error",`${a.t("general:Failed to connect to server")}: ${i}`)})}deleteUser(e){A(this.state.data[e]).then(i=>{i.status==="ok"?(l("success",a.t("general:Successfully deleted")),this.setState({data:O(this.state.data,e),pagination:{total:this.state.pagination.total-1}})):l("error",`${a.t("general:Failed to delete")}: ${i.msg}`)}).catch(i=>{l("error",`${a.t("general:Failed to connect to server")}: ${i}`)})}uploadFile(e){const{status:i,response:o}=e.file;if(i==="done")if(o.status==="ok"){l("success","Users uploaded successfully, refreshing the page");const{pagination:t}=this.state;this.fetch({pagination:t})}else l("error",`Users failed to upload: ${o.msg}`);else i==="error"&&l("error","File failed to upload")}renderUpload(){const e={name:"file",accept:".xlsx",method:"post",action:`${B}/api/upload-users`,withCredentials:!0,onChange:i=>{this.uploadFile(i)}};return s.jsx(G,{...e,children:s.jsxs(m,{type:"primary",size:"small",children:[s.jsx(J,{})," ",a.t("user:Upload (.xlsx)")]})})}renderTable(e){const i=[{title:a.t("general:Organization"),dataIndex:"owner",key:"owner",width:p()?"100px":"120px",fixed:"left",sorter:!0,...this.getColumnSearchProps("owner"),render:(t,n,r)=>s.jsx(x,{to:`/organizations/${t}`,children:t})},{title:a.t("general:Application"),dataIndex:"signupApplication",key:"signupApplication",width:p()?"100px":"120px",fixed:"left",sorter:!0,...this.getColumnSearchProps("signupApplication"),render:(t,n,r)=>s.jsx(x,{to:`/applications/${n.owner}/${t}`,children:t})},{title:a.t("general:Name"),dataIndex:"name",key:"name",width:p()?"80px":"110px",fixed:"left",sorter:!0,...this.getColumnSearchProps("name"),render:(t,n,r)=>s.jsx(x,{to:`/users/${n.owner}/${t}`,children:t})},{title:a.t("general:Created time"),dataIndex:"createdTime",key:"createdTime",width:"160px",sorter:!0,render:(t,n,r)=>P(t)},{title:a.t("general:Display name"),dataIndex:"displayName",key:"displayName",sorter:!0,...this.getColumnSearchProps("displayName")},{title:a.t("general:Avatar"),dataIndex:"avatar",key:"avatar",width:"80px",render:(t,n,r)=>s.jsx("a",{target:"_blank",rel:"noreferrer",href:t,children:s.jsx("img",{src:t,alt:t,width:50})})},{title:a.t("general:Email"),dataIndex:"email",key:"email",width:"160px",sorter:!0,...this.getColumnSearchProps("email"),render:(t,n,r)=>s.jsx("a",{href:`mailto:${t}`,children:t})},{title:a.t("general:Phone"),dataIndex:"phone",key:"phone",width:"120px",sorter:!0,...this.getColumnSearchProps("phone")},{title:a.t("user:Affiliation"),dataIndex:"affiliation",key:"affiliation",width:"140px",sorter:!0,...this.getColumnSearchProps("affiliation")},{title:a.t("user:Country/Region"),dataIndex:"region",key:"region",width:"140px",sorter:!0,...this.getColumnSearchProps("region"),render:async(t,n,r)=>await T().getName(n.region,k(),{select:"official"})},{title:a.t("user:Tag"),dataIndex:"tag",key:"tag",width:"110px",sorter:!0,...this.getColumnSearchProps("tag"),render:(t,n,r)=>{var f,w;const d={};return(w=(f=this.state.organization)==null?void 0:f.tags)==null||w.map((b,Q)=>{const g=b.split("|"),z=k()!=="zh"?g[0]:g[1];d[g[0]]=z}),d[t]}},{title:a.t("user:Is admin"),dataIndex:"isAdmin",key:"isAdmin",width:"110px",sorter:!0,render:(t,n,r)=>s.jsx(u,{disabled:!0,checkedChildren:"ON",unCheckedChildren:"OFF",checked:t})},{title:a.t("user:Is globalThis admin"),dataIndex:"isGlobalAdmin",key:"isGlobalAdmin",width:"140px",sorter:!0,render:(t,n,r)=>s.jsx(u,{disabled:!0,checkedChildren:"ON",unCheckedChildren:"OFF",checked:t})},{title:a.t("user:Is forbidden"),dataIndex:"isForbidden",key:"isForbidden",width:"110px",sorter:!0,render:(t,n,r)=>s.jsx(u,{disabled:!0,checkedChildren:"ON",unCheckedChildren:"OFF",checked:t})},{title:a.t("user:Is deleted"),dataIndex:"isDeleted",key:"isDeleted",width:"110px",sorter:!0,render:(t,n,r)=>s.jsx(u,{disabled:!0,checkedChildren:"ON",unCheckedChildren:"OFF",checked:t})},{title:a.t("general:Action"),dataIndex:"",key:"op",width:"190px",fixed:p()?"false":"right",render:(t,n,r)=>{const d=n.owner===this.props.account.owner&&n.name===this.props.account.name;return s.jsxs("div",{children:[s.jsx(m,{style:{marginTop:"10px",marginBottom:"10px",marginRight:"10px"},type:"primary",onClick:()=>this.props.history.push(`/users/${n.owner}/${n.name}`),children:a.t("general:Edit")}),s.jsx(E,{title:a.t("general:Sure to delete")+`: ${n.name} ?`,onConfirm:()=>this.deleteUser(r),disabled:d})]})}}],o={total:this.state.pagination.total,showQuickJumper:!0,showSizeChanger:!0,showTotal:()=>a.t("general:{total} in total").replace("{total}",this.state.pagination.total)};return s.jsx("div",{children:s.jsx(K,{scroll:{x:"max-content"},columns:i,dataSource:e,rowKey:t=>`${t.owner}/${t.name}`,size:"middle",bordered:!0,pagination:o,title:()=>s.jsxs("div",{children:[a.t("general:Users"),"    ",s.jsx(m,{style:{marginRight:"5px"},type:"primary",size:"small",onClick:this.addUser.bind(this),children:a.t("general:Add")}),this.renderUpload()]}),loading:this.state.loading,onChange:this.handleTableChange})})}getOrganization(e){D("admin",e).then(i=>{this.setState({organization:i})})}}export{ae as default};
